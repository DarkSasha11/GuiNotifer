-- =========================================================
-- âš¡ CAPY INSTA STEAL + TELEPORT SYSTEM (HYBRID)
-- =========================================================

local function safeCall(func, ...)
    local success, result = pcall(func, ...)
    return success, result
end

-- Cleanup
if _G.MySkyCleanup then pcall(_G.MySkyCleanup) end
_G.MySkyCleanup = function()
    for _, conn in ipairs(_G.MySkyConnections or {}) do pcall(function() conn:Disconnect() end) end
    for _, part in ipairs(workspace:GetChildren()) do
        if part.Name:find("myskyp") or part.Name:find("Cosmic") then pcall(function() part:Destroy() end) end
    end
    if game.CoreGui:FindFirstChild("SemiInstaSteal") then pcall(function() game.CoreGui.SemiInstaSteal:Destroy() end) end
end
pcall(_G.MySkyCleanup)

-- Services
local Players = game:GetService("Players")
local LocalPlayer = Players.LocalPlayer
local ProximityPromptService = game:GetService("ProximityPromptService")
local VirtualInputManager = game:GetService("VirtualInputManager")
local TweenService = game:GetService("TweenService")
local UserInputService = game:GetService("UserInputService")
local RunService = game:GetService("RunService")

local connections = {}
_G.MySkyConnections = connections

-- CONFIG
local TP_POSITIONS = {
    BASE1 = {
        INFO_POS = CFrame.new(334.76, 55.334, 99.40),
        TELEPORT_POS = CFrame.new(-352.98, -7.30, 74.3),
    },
    BASE2 = {
        INFO_POS = CFrame.new(334.76, 55.334, 19.17),
        TELEPORT_POS = CFrame.new(-352.98, -7.30, 45.76),
    }
}

local CONFIG = {
    AUTO_STEAL = true,
    RADIUS = 25,
    INSTANT_DELAY = 0.05
}

-- === FAST STEAL LOGIC ===
local function fastSteal(prompt)
    if not prompt or not prompt.Parent then return end
    
    -- Bypass Hold Duration
    if getconnections then
        for _, conn in ipairs(getconnections(prompt.PromptButtonHoldBegan)) do conn:Fire() end
        local start = tick()
        while tick() - start < CONFIG.INSTANT_DELAY do RunService.Heartbeat:Wait() end
        for _, conn in ipairs(getconnections(prompt.Triggered)) do conn:Fire() end
        for _, conn in ipairs(getconnections(prompt.PromptButtonHoldEnded)) do conn:Fire() end
    else
        -- Fallback for standard executors
        fireproximityprompt(prompt)
    end
end

local function autoStealAfterTP()
    task.wait(0.2) -- Wait for TP
    print("âš¡ Auto-Steal Scanning...")
    
    local char = LocalPlayer.Character
    if not char then return end
    local hrp = char:FindFirstChild("HumanoidRootPart")
    
    local nearestPrompt = nil
    local minDist = 30 -- Radius check
    
    for _, prompt in ipairs(workspace:GetDescendants()) do
        if prompt:IsA("ProximityPrompt") and prompt.Parent then
            local dist = (prompt.Parent:GetPivot().Position - hrp.Position).Magnitude
            if dist < minDist then
                minDist = dist
                nearestPrompt = prompt
            end
        end
    end
    
    if nearestPrompt then
        print("âš¡ Stealing: " .. nearestPrompt.Parent.Name)
        fastSteal(nearestPrompt)
    else
        print("âš ï¸ No prompt found nearby")
    end
end

-- === TELEPORT LOGIC ===
local lastTeleportTime = 0
local TELEPORT_COOLDOWN = 0.8

local function getCurrentBasePosition()
    if not LocalPlayer.Character or not LocalPlayer.Character:FindFirstChild("HumanoidRootPart") then
        return TP_POSITIONS.BASE1.INFO_POS
    end
    local hrp = LocalPlayer.Character.HumanoidRootPart
    local d1 = (hrp.Position - TP_POSITIONS.BASE1.INFO_POS.Position).Magnitude
    local d2 = (hrp.Position - TP_POSITIONS.BASE2.INFO_POS.Position).Magnitude
    return d1 < d2 and TP_POSITIONS.BASE1.INFO_POS or TP_POSITIONS.BASE2.INFO_POS
end

local function executeTP()
    if tick() - lastTeleportTime < TELEPORT_COOLDOWN then return end
    lastTeleportTime = tick()
    
    local char = LocalPlayer.Character
    if not char then return end
    local hrp = char:FindFirstChild("HumanoidRootPart")
    local hum = char:FindFirstChild("Humanoid")
    
    local carpet = char:FindFirstChild("Flying Carpet") or LocalPlayer.Backpack:FindFirstChild("Flying Carpet")
    if not carpet then
        warn("Flying Carpet not found!")
        return
    end
    
    local isBase1 = getCurrentBasePosition() == TP_POSITIONS.BASE1.INFO_POS
    
    task.spawn(function()
        hum:EquipTool(carpet)
        
        if isBase1 then
            hrp.CFrame = CFrame.new(-351.49, -6.65, 113.72)
            task.wait(0.15)
            hrp.CFrame = CFrame.new(-378.14, -6.00, 26.43)
            task.wait(0.15)
            hrp.CFrame = CFrame.new(-334.80, -5.04, 18.90)
        else
            hrp.CFrame = CFrame.new(-352.54, -6.83, 6.66)
            task.wait(0.15)
            hrp.CFrame = CFrame.new(-372.90, -6.20, 102.00)
            task.wait(0.15)
            hrp.CFrame = CFrame.new(-335.08, -5.10, 101.40)
        end
        
        -- ðŸ”¥ TRIGGER AUTO STEAL ðŸ”¥
        autoStealAfterTP()
    end)
end

-- === EVENT LISTENER ===
ProximityPromptService.PromptButtonHoldEnded:Connect(function(prompt, who)
    if who == LocalPlayer and (prompt.Name == "Steal" or prompt.ActionText == "Steal") then
        executeTP()
    end
end)

-- === GUI CREATION ===
local ScreenGui = Instance.new("ScreenGui")
ScreenGui.Name = "CapyInstaStealUI"
ScreenGui.ResetOnSpawn = false
if pcall(function() ScreenGui.Parent = game.CoreGui end) then else ScreenGui.Parent = LocalPlayer.PlayerGui end

-- Main Frame
local Main = Instance.new("Frame")
Main.Size = UDim2.new(0, 300, 0, 150)
Main.Position = UDim2.new(0.5, -150, 0.8, 0)
Main.BackgroundColor3 = Color3.fromRGB(20, 20, 25)
Main.BorderSizePixel = 0
Main.Active = true
Main.Draggable = true
Main.Parent = ScreenGui

local UICorner = Instance.new("UICorner")
UICorner.CornerRadius = UDim.new(0, 12)
UICorner.Parent = Main

local Stroke = Instance.new("UIStroke")
Stroke.Color = Color3.fromRGB(255, 170, 0)
Stroke.Thickness = 2
Stroke.Parent = Main

local Title = Instance.new("TextLabel")
Title.Text = "ðŸ¥” CAPY INSTA STEAL"
Title.Font = Enum.Font.GothamBlack
Title.TextSize = 18
Title.TextColor3 = Color3.fromRGB(255, 170, 0)
Title.Size = UDim2.new(1, 0, 0, 40)
Title.BackgroundTransparency = 1
Title.Parent = Main

local Status = Instance.new("TextLabel")
Status.Text = "STATUS: READY"
Status.Font = Enum.Font.GothamBold
Status.TextSize = 14
Status.TextColor3 = Color3.fromRGB(100, 255, 100)
Status.Size = UDim2.new(1, 0, 0, 30)
Status.Position = UDim2.new(0, 0, 0, 40)
Status.BackgroundTransparency = 1
Status.Parent = Main

local ToggleBtn = Instance.new("TextButton")
ToggleBtn.Text = "FORCE TELEPORT (G)"
ToggleBtn.Font = Enum.Font.GothamBold
ToggleBtn.TextSize = 14
ToggleBtn.TextColor3 = Color3.fromRGB(255, 255, 255)
ToggleBtn.BackgroundColor3 = Color3.fromRGB(40, 40, 50)
ToggleBtn.Size = UDim2.new(0.8, 0, 0, 40)
ToggleBtn.Position = UDim2.new(0.1, 0, 0.6, 0)
ToggleBtn.Parent = Main
Instance.new("UICorner", ToggleBtn).CornerRadius = UDim.new(0, 8)

ToggleBtn.MouseButton1Click:Connect(executeTP)

-- Keybind G
UserInputService.InputBegan:Connect(function(input, gp)
    if not gp and input.KeyCode == Enum.KeyCode.G then
        executeTP()
    end
end)

print("ðŸ¥” Capy Insta Steal Loaded!")
