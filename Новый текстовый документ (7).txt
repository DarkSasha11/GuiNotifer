if not game:IsLoaded() then game.Loaded:Wait() end

-- Services
local Players = game:GetService("Players")
local ProximityPromptService = game:GetService("ProximityPromptService")
local TweenService = game:GetService("TweenService")
local RunService = game:GetService("RunService")
local Workspace = game:GetService("Workspace")
local UserInputService = game:GetService("UserInputService")
local lp = Players.LocalPlayer

-- FFlags
local fflags = {
    GameNetPVHeaderRotationalVelocityZeroCutoffExponent = -5000,
    LargeReplicatorWrite5 = true,
    LargeReplicatorEnabled9 = true,
    AngularVelociryLimit = 360,
    TimestepArbiterVelocityCriteriaThresholdTwoDt = 2147483646,
    S2PhysicsSenderRate = 15000,
    DisableDPIScale = true,
    MaxDataPacketPerSend = 2147483647,
    PhysicsSenderMaxBandwidthBps = 20000,
    TimestepArbiterHumanoidLinearVelThreshold = 21,
    MaxMissedWorldStepsRemembered = -2147483648,
    PlayerHumanoidPropertyUpdateRestrict = true,
    SimDefaultHumanoidTimestepMultiplier = 0,
    StreamJobNOUVolumeLengthCap = 2147483647,
    DebugSendDistInSteps = -2147483648,
    GameNetDontSendRedundantNumTimes = 1,
    CheckPVLinearVelocityIntegrateVsDeltaPositionThresholdPercent = 1,
    CheckPVDifferencesForInterpolationMinVelThresholdStudsPerSecHundredth = 1,
    LargeReplicatorSerializeRead3 = true,
    ReplicationFocusNouExtentsSizeCutoffForPauseStuds = 2147483647,
    CheckPVCachedVelThresholdPercent = 10,
    CheckPVDifferencesForInterpolationMinRotVelThresholdRadsPerSecHundredth = 1,
    GameNetDontSendRedundantDeltaPositionMillionth = 1,
    InterpolationFrameVelocityThresholdMillionth = 5,
    StreamJobNOUVolumeCap = 2147483647,
    InterpolationFrameRotVelocityThresholdMillionth = 5,
    CheckPVCachedRotVelThresholdPercent = 10,
    WorldStepMax = 30,
    InterpolationFramePositionThresholdMillionth = 5,
    TimestepArbiterHumanoidTurningVelThreshold = 1,
    SimOwnedNOUCountThresholdMillionth = 2147483647,
    GameNetPVHeaderLinearVelocityZeroCutoffExponent = -5000,
    NextGenReplicatorEnabledWrite4 = true,
    TimestepArbiterOmegaThou = 1073741823,
    MaxAcceptableUpdateDelay = 1,
    LargeReplicatorSerializeWrite4 = true
}

local function setfflags()
    for k, v in pairs(fflags) do
        pcall(function()
            setfflag(k, tostring(v))
        end)
    end
end

local function forceRespawn()
    local char = lp.Character
    if not char then return end

    local humanoid = char:FindFirstChildOfClass("Humanoid")
    if humanoid then
        humanoid:ChangeState(Enum.HumanoidStateType.Dead)
    end

    char:ClearAllChildren()

    local dummy = Instance.new("Model")
    dummy.Parent = Workspace
    lp.Character = dummy
    task.wait()
    lp.Character = char
    dummy:Destroy()
end

-- Base Zones
local bases = {
    Base1 = {
        center = Vector3.new(-335.65, -5.40, 14),
        positions = {
            Vector3.new(-335.65, -5.40, -10.99),
            Vector3.new(-336.05, -5.34, 18.08)
        }
    },
    Base2 = {
        center = Vector3.new(-335.41, -5.40, 114),
        positions = {
            Vector3.new(-335.41, -5.40, 102.42),
            Vector3.new(-334.89, -5.40, 125.81)
        }
    }
}

local currentBase = nil

local function isOnBase(pos, radius)
    local root = lp.Character and lp.Character:FindFirstChild("HumanoidRootPart")
    return root and (root.Position - pos).Magnitude <= (radius or 5)
end

local function detectCurrentBase()
    local root = lp.Character and lp.Character:FindFirstChild("HumanoidRootPart")
    if not root then return nil end
    
    for name, data in pairs(bases) do
        if (root.Position - data.center).Magnitude < 30 then
            return name
        end
    end
    return nil
end

-- Cosmic Indicators
local function createCosmicIndicator(name, position, color, text)
    local part = Instance.new("Part")
    part.Name = name
    part.Size = Vector3.new(3.8, 0.3, 3.8)
    part.Material = Enum.Material.Plastic
    part.Color = color
    part.Transparency = 0.57
    part.Anchored = true
    part.CanCollide = false
    part.Position = position
    part.Parent = Workspace

    local billboard = Instance.new("BillboardGui")
    billboard.Size = UDim2.new(0, 200, 0, 50)
    billboard.StudsOffset = Vector3.new(0, 4, 0)
    billboard.AlwaysOnTop = true
    billboard.Parent = part

    local textLabel = Instance.new("TextLabel")
    textLabel.Size = UDim2.new(1, 0, 1, 0)
    textLabel.BackgroundTransparency = 1
    textLabel.Text = text
    textLabel.TextColor3 = Color3.fromRGB(255, 255, 255)
    textLabel.TextStrokeTransparency = 0.3
    textLabel.TextStrokeColor3 = color
    textLabel.Font = Enum.Font.GothamBold
    textLabel.TextSize = 18
    textLabel.Parent = billboard

    return part
end

task.spawn(function()
    createCosmicIndicator("CosmicBase1_1", bases.Base1.positions[1], Color3.fromRGB(255, 50, 50), "BASE 1 - SPOT 1")
    createCosmicIndicator("CosmicBase1_2", bases.Base1.positions[2], Color3.fromRGB(255, 50, 50), "BASE 1 - SPOT 2")
    createCosmicIndicator("CosmicBase2_1", bases.Base2.positions[1], Color3.fromRGB(50, 150, 255), "BASE 2 - SPOT 1")
    createCosmicIndicator("CosmicBase2_2", bases.Base2.positions[2], Color3.fromRGB(50, 150, 255), "BASE 2 - SPOT 2")
end)

-- Main UI
local sg = Instance.new("ScreenGui")
sg.Parent = lp:WaitForChild("PlayerGui")
sg.ResetOnSpawn = false
sg.Name = "CapyInstaStealGUI"

local main = Instance.new("Frame", sg)
main.Size = UDim2.fromOffset(320, 450)
main.Position = UDim2.fromScale(0.5, 0.5)
main.AnchorPoint = Vector2.new(0.5, 0.5)
main.BackgroundColor3 = Color3.fromRGB(15, 18, 25)
main.Active = true
main.Draggable = true
Instance.new("UICorner", main).CornerRadius = UDim.new(0, 14)

local stroke = Instance.new("UIStroke", main)
stroke.Color = Color3.fromRGB(120, 160, 255)
stroke.Thickness = 2.5
stroke.Transparency = 0.2

local grad = Instance.new("UIGradient", main)
grad.Color = ColorSequence.new{
    ColorSequenceKeypoint.new(0, Color3.fromRGB(25, 30, 40)),
    ColorSequenceKeypoint.new(1, Color3.fromRGB(15, 18, 25))
}
grad.Rotation = 135

-- Header
local header = Instance.new("Frame", main)
header.Size = UDim2.new(1, 0, 0, 60)
header.BackgroundColor3 = Color3.fromRGB(50, 60, 80)
header.BorderSizePixel = 0
Instance.new("UICorner", header).CornerRadius = UDim.new(0, 14)

local headerStroke = Instance.new("UIStroke", header)
headerStroke.Color = Color3.fromRGB(120, 160, 255)
headerStroke.Thickness = 1.5

local title = Instance.new("TextLabel", header)
title.Size = UDim2.new(1, 0, 0, 30)
title.Position = UDim2.fromOffset(0, 5)
title.BackgroundTransparency = 1
title.Text = "ðŸ¹ CAPY INSTA STEAL"
title.Font = Enum.Font.GothamBlack
title.TextSize = 20
title.TextColor3 = Color3.fromRGB(255, 255, 255)

local subtitle = Instance.new("TextLabel", header)
subtitle.Size = UDim2.new(1, 0, 0, 20)
subtitle.Position = UDim2.fromOffset(0, 35)
subtitle.BackgroundTransparency = 1
subtitle.Text = "by ARTFUL & MYSKYP"
subtitle.Font = Enum.Font.GothamBold
subtitle.TextSize = 12
subtitle.TextColor3 = Color3.fromRGB(180, 200, 255)

-- Status display
local statusContainer = Instance.new("Frame", main)
statusContainer.Size = UDim2.new(1, -20, 0, 70)
statusContainer.Position = UDim2.fromOffset(10, 70)
statusContainer.BackgroundColor3 = Color3.fromRGB(25, 30, 40)
Instance.new("UICorner", statusContainer).CornerRadius = UDim.new(0, 10)

local statusStroke = Instance.new("UIStroke", statusContainer)
statusStroke.Color = Color3.fromRGB(100, 150, 255)
statusStroke.Thickness = 1.5
statusStroke.Transparency = 0.5

local baseLabel = Instance.new("TextLabel", statusContainer)
baseLabel.Size = UDim2.new(1, -10, 0, 25)
baseLabel.Position = UDim2.fromOffset(5, 5)
baseLabel.BackgroundTransparency = 1
baseLabel.Text = "ðŸ“ Current Base: None"
baseLabel.Font = Enum.Font.GothamBold
baseLabel.TextSize = 13
baseLabel.TextColor3 = Color3.fromRGB(255, 200, 100)
baseLabel.TextXAlignment = Enum.TextXAlignment.Left

local statusLabel = Instance.new("TextLabel", statusContainer)
statusLabel.Size = UDim2.new(1, -10, 0, 20)
statusLabel.Position = UDim2.fromOffset(5, 30)
statusLabel.BackgroundTransparency = 1
statusLabel.Text = "âš¡ Status: Ready"
statusLabel.Font = Enum.Font.Gotham
statusLabel.TextSize = 12
statusLabel.TextColor3 = Color3.fromRGB(150, 255, 150)
statusLabel.TextXAlignment = Enum.TextXAlignment.Left

local tpCheckLabel = Instance.new("TextLabel", statusContainer)
tpCheckLabel.Size = UDim2.new(1, -10, 0, 20)
tpCheckLabel.Position = UDim2.fromOffset(5, 50)
tpCheckLabel.BackgroundTransparency = 1
tpCheckLabel.Text = ""
tpCheckLabel.Font = Enum.Font.GothamBold
tpCheckLabel.TextSize = 11
tpCheckLabel.TextColor3 = Color3.fromRGB(255, 255, 100)
tpCheckLabel.TextXAlignment = Enum.TextXAlignment.Left

-- Button maker
local function btn(txt, y, emoji)
    local b = Instance.new("TextButton", main)
    b.Size = UDim2.new(1, -40, 0, 40)
    b.Position = UDim2.fromOffset(20, y)
    b.Text = (emoji and emoji .. " " or "") .. txt
    b.Font = Enum.Font.GothamBold
    b.TextSize = 14
    b.TextColor3 = Color3.fromRGB(255, 255, 255)
    b.BackgroundColor3 = Color3.fromRGB(50, 60, 80)
    b.AutoButtonColor = false
    Instance.new("UICorner", b).CornerRadius = UDim.new(0, 10)

    local s = Instance.new("UIStroke", b)
    s.Color = Color3.fromRGB(120, 160, 255)
    s.Thickness = 2
    s.Transparency = 0.4

    b.MouseEnter:Connect(function()
        TweenService:Create(b, TweenInfo.new(0.2), {BackgroundColor3 = Color3.fromRGB(80, 90, 120)}):Play()
        TweenService:Create(s, TweenInfo.new(0.2), {Transparency = 0.1}):Play()
    end)

    b.MouseLeave:Connect(function()
        TweenService:Create(b, TweenInfo.new(0.2), {BackgroundColor3 = Color3.fromRGB(50, 60, 80)}):Play()
        TweenService:Create(s, TweenInfo.new(0.2), {Transparency = 0.4}):Play()
    end)

    return b
end

local setpos = btn("SET POSITION", 155, "ðŸ“Œ")
local desync = btn("ENABLE DESYNC", 205, "ðŸ”„")
local unwalk = btn("UNWALK ANIM", 255, "ðŸš«")
local autoTpLeft = btn("AUTO TP LEFT", 305, "â¬…ï¸")
local autoTpRight = btn("AUTO TP RIGHT", 355, "âž¡ï¸")

-- Variables
local posA, posB
local beamA, beamB
local partA, partB
local unwalkActive = false
local unwalkConn

-- Beam maker
local function makeBeam(targetPos, slot)
    local root = lp.Character and lp.Character:FindFirstChild("HumanoidRootPart")
    if not root then return end

    local anchor = Instance.new("Part")
    anchor.Anchored = true
    anchor.CanCollide = false
    anchor.Transparency = 1
    anchor.CFrame = CFrame.new(targetPos)
    anchor.Parent = Workspace

    local att0 = Instance.new("Attachment", anchor)
    local att1 = Instance.new("Attachment", root)

    local b = Instance.new("Beam")
    b.Attachment0 = att0
    b.Attachment1 = att1
    b.Width0 = 0.8
    b.Width1 = 0.8
    b.FaceCamera = true
    b.LightEmission = 0.95
    b.Color = ColorSequence.new{
        ColorSequenceKeypoint.new(0, Color3.fromRGB(120, 160, 255)),
        ColorSequenceKeypoint.new(0.5, Color3.fromRGB(255, 255, 100)),
        ColorSequenceKeypoint.new(1, Color3.fromRGB(120, 160, 255))
    }
    b.Transparency = NumberSequence.new{
        NumberSequenceKeypoint.new(0, 0.3),
        NumberSequenceKeypoint.new(0.5, 0.1),
        NumberSequenceKeypoint.new(1, 0.3)
    }
    b.Parent = Workspace

    if slot == 1 then
        if beamA then beamA:Destroy() end
        if partA then partA:Destroy() end
        beamA, partA = b, anchor
    else
        if beamB then beamB:Destroy() end
        if partB then partB:Destroy() end
        beamB, partB = b, anchor
    end
end

-- Check if brainrot exists near position
local function checkBrainrotNearPosition(position, radius)
    radius = radius or 10
    
    for _, obj in pairs(Workspace:GetDescendants()) do
        if obj:IsA("Model") and obj.Name:lower():find("brainrot") then
            local primaryPart = obj.PrimaryPart or obj:FindFirstChildWhichIsA("BasePart")
            if primaryPart then
                local distance = (primaryPart.Position - position).Magnitude
                if distance <= radius then
                    return true, distance, obj.Name
                end
            end
        end
    end
    
    return false, nil, nil
end

-- Set Position button with TP check
setpos.MouseButton1Click:Connect(function()
    local root = lp.Character and lp.Character:FindFirstChild("HumanoidRootPart")
    if not root then return end
    
    posA = root.CFrame
    makeBeam(posA.Position, 1)
    statusLabel.Text = "âš¡ Status: Position Set"
    
    -- Check for brainrot near position
    task.spawn(function()
        task.wait(0.5)
        local hasBrainrot, distance, brainrotName = checkBrainrotNearPosition(posA.Position, 15)
        
        if hasBrainrot then
            tpCheckLabel.Text = string.format("âœ… BRAINROT DETECTED! (%.1fm)", distance)
            tpCheckLabel.TextColor3 = Color3.fromRGB(100, 255, 100)
            statusStroke.Color = Color3.fromRGB(100, 255, 100)
        else
            tpCheckLabel.Text = "âŒ NO BRAINROT NEARBY!"
            tpCheckLabel.TextColor3 = Color3.fromRGB(255, 100, 100)
            statusStroke.Color = Color3.fromRGB(255, 100, 100)
        end
        
        task.wait(3)
        tpCheckLabel.Text = ""
        statusStroke.Color = Color3.fromRGB(100, 150, 255)
    end)
end)

-- Desync button
desync.MouseButton1Click:Connect(function()
    setfflags()
    forceRespawn()
    statusLabel.Text = "âš¡ Status: Desync Enabled"
    
    task.spawn(function()
        task.wait(2)
        statusLabel.Text = "âš¡ Status: Ready"
    end)
end)

-- Unwalk animation
unwalk.MouseButton1Click:Connect(function()
    local char = lp.Character
    if not char then return end

    local hum = char:FindFirstChildOfClass("Humanoid")
    if not hum then return end

    local anim = hum:FindFirstChildWhichIsA("Animator")
    if not anim then return end

    if unwalkActive then
        if unwalkConn then unwalkConn:Disconnect() unwalkConn = nil end
        statusLabel.Text = "âš¡ Status: Animations Restored"
        unwalk.Text = "ðŸš« UNWALK ANIM"
        unwalkActive = false
    else
        if unwalkConn then unwalkConn:Disconnect() unwalkConn = nil end

        unwalkConn = RunService.Heartbeat:Connect(function()
            for _, track in pairs(anim:GetPlayingAnimationTracks()) do
                track:Stop()
                track:AdjustSpeed(0)
            end
        end)

        statusLabel.Text = "âš¡ Status: Animations Stopped"
        unwalk.Text = "âœ… RESTORE ANIM"
        unwalkActive = true
    end
end)

-- Auto TP Left
autoTpLeft.MouseButton1Click:Connect(function()
    local root = lp.Character and lp.Character:FindFirstChild("HumanoidRootPart")
    if not root then return end
    
    local sequence = {
        CFrame.new(-370.810913, -7.00000334, 41.2687263),
        CFrame.new(-336.355286, -5.10107088, 17.2327671)
    }
    
    root.CFrame = sequence[1]
    task.wait(0.1)
    root.CFrame = sequence[2]
    
    statusLabel.Text = "âš¡ Status: TP Left Executed"
    task.wait(2)
    statusLabel.Text = "âš¡ Status: Ready"
end)

-- Auto TP Right
autoTpRight.MouseButton1Click:Connect(function()
    local root = lp.Character and lp.Character:FindFirstChild("HumanoidRootPart")
    if not root then return end
    
    local sequence = {
        CFrame.new(-354.782867, -7.00000334, 92.8209305),
        CFrame.new(-336.942902, -5.10106993, 99.3276443)
    }
    
    root.CFrame = sequence[1]
    task.wait(0.1)
    root.CFrame = sequence[2]
    
    statusLabel.Text = "âš¡ Status: TP Right Executed"
    task.wait(2)
    statusLabel.Text = "âš¡ Status: Ready"
end)

-- Base detection loop
task.spawn(function()
    while task.wait(0.5) do
        currentBase = detectCurrentBase()
        
        if currentBase then
            baseLabel.Text = "ðŸ“ Current Base: " .. currentBase
            baseLabel.TextColor3 = currentBase == "Base1" and Color3.fromRGB(255, 100, 100) or Color3.fromRGB(100, 150, 255)
        else
            baseLabel.Text = "ðŸ“ Current Base: None"
            baseLabel.TextColor3 = Color3.fromRGB(255, 200, 100)
        end
    end
end)

-- Auto target closest brainrot
task.spawn(function()
    while task.wait(1) do
        local root = lp.Character and lp.Character:FindFirstChild("HumanoidRootPart")
        if not root then continue end

        local bestBrainrot = nil
        local bestDist = math.huge
        
        for _, obj in pairs(Workspace:GetDescendants()) do
            if obj:IsA("Model") and obj.Name:lower():find("brainrot") then
                local primaryPart = obj.PrimaryPart or obj:FindFirstChildWhichIsA("BasePart")
                if primaryPart then
                    -- Filter by base if on one
                    if currentBase == "Base1" and primaryPart.Position.Z > 60 then continue end
                    if currentBase == "Base2" and primaryPart.Position.Z < 60 then continue end
                    
                    local dist = (root.Position - primaryPart.Position).Magnitude
                    if dist < bestDist and dist < 200 then
                        bestDist = dist
                        bestBrainrot = primaryPart
                    end
                end
            end
        end

        if bestBrainrot then
            posB = CFrame.new(bestBrainrot.Position)
            makeBeam(bestBrainrot.Position, 2)
        end
    end
end)

-- Steal TP
ProximityPromptService.PromptButtonHoldEnded:Connect(function(prompt, sender)
    if sender ~= lp then return end
    if prompt.Name ~= "Steal" and prompt.ActionText ~= "Steal" then return end

    local root = lp.Character and lp.Character:FindFirstChild("HumanoidRootPart")
    if not root then return end

    if posA then 
        root.CFrame = posA 
        statusLabel.Text = "âš¡ Status: Steal Executed - Position A"
    end
    
    if posB then 
        task.wait(0.05) 
        root.CFrame = posB 
        statusLabel.Text = "âš¡ Status: Steal Executed - Position B"
    end
    
    task.wait(2)
    statusLabel.Text = "âš¡ Status: Ready"
end)

-- Startup animation
main.Size = UDim2.fromOffset(0, 0)
main.BackgroundTransparency = 1

TweenService:Create(main, TweenInfo.new(0.5, Enum.EasingStyle.Back, Enum.EasingDirection.Out), {
    Size = UDim2.fromOffset(320, 450),
    BackgroundTransparency = 0
}):Play()

print("âœ… CAPY INSTA STEAL Loaded!")
print("ðŸ“ Base indicators created")
print("ðŸ¹ by ARTFUL & MYSKYP")
